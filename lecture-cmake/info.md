# Лекция: Использование CMake и Makefile для C++ проектов

В этой лекции мы разберем создание проекта на C++ с использованием CMake и Makefile для управления процессом сборки.

[ссылка помошник](https://ps-group.github.io/cxx/cmake_cheatsheet)

## Введение в CMake и Makefile

CMake — это инструмент для настройки сборки проекта, который упрощает работу с компиляцией, подключением библиотек и управлением зависимостями. Makefile служит интерфейсом для использования CMake из командной строки и позволяет запускать различные конфигурации сборки, такие как Debug и Release, а также определять каталоги и типы библиотек.

Наш проект будет состоять из следующих компонентов:
1. Основной файл программы `solution.cpp`, который выполняет простое решение квадратного уравнения, используя параметры из командной строки.
2. Библиотека для парсинга аргументов командной строки.
3. Библиотека для решения уравнения, конфигурируемая через CMake (например, использование `float` или `double` для точности).

---

## Makefile: Управление сборкой

**Makefile** — это инструмент для автоматизации командной сборки. Давайте посмотрим на пример `Makefile`, который позволяет настраивать параметры сборки CMake.

```makefile
# Makefile для управления сборкой проекта через CMake

# Переменные сборки по умолчанию
BUILD_DIR = build         # Каталог для файлов сборки
BUILD_TYPE = Debug        # Тип сборки: Debug или Release
GENERATOR = Ninja         # Генератор сборки: Ninja или Unix Makefiles
LIB_TYPE = STATIC         # Тип библиотеки по умолчанию (STATIC или SHARED)
POINT_TYPE = short        # Тип точности для решения квадратного уравнения

# Команда сборки: выполняет configure и build
all: configure build
```

### Пояснение к коду:

1. **BUILD_DIR = build**
   - **Описание**: `BUILD_DIR` указывает, в какой директории будут созданы временные файлы сборки. 
   - **Почему это важно**: Сохранение файлов сборки в отдельной директории помогает поддерживать порядок в проекте, а также упрощает удаление всех временных файлов одной командой.

2. **BUILD_TYPE = Debug**
   - **Описание**: Параметр, определяющий тип сборки (Debug или Release).
   - **Почему это важно**: В режиме Debug добавляются отладочные символы, которые помогают тестировать и искать ошибки. В Release-сборке код оптимизируется для лучшей производительности.

3. **GENERATOR = Ninja**
   - **Описание**: Указание генератора сборки. Ninja — это быстрая система сборки, которую можно использовать наряду с Make.
   - **Почему это важно**: Разные генераторы обеспечивают разные функции и скорости сборки. Ninja обычно быстрее Make.

4. **LIB_TYPE = STATIC**
   - **Описание**: Этот параметр определяет тип библиотеки (STATIC или SHARED).
   - **Почему это важно**: Статическая библиотека объединяется с исполняемым файлом, а динамическая (SHARED) компилируется отдельно и подключается во время выполнения.

5. **POINT_TYPE = short**
   - **Описание**: Параметр, определяющий тип точности (float или double) для вычислений. Выбор типа через `POINT_TYPE` позволяет адаптировать код под задачи, где важны скорость (short) или точность (long).

---

### Основные команды Makefile

```makefile
# Конфигурация CMake с выбранными параметрами
configure:
	cmake -S . -B $(BUILD_DIR) -DCMAKE_BUILD_TYPE=$(BUILD_TYPE) \
		-DCMAKE_GENERATOR=$(GENERATOR) \
		-DLIB_TYPE=$(LIB_TYPE) \
		-DPOINTTYPE=$(POINT_TYPE)
```

1. **configure**:
   - **Описание**: Команда `configure` запускает CMake и настраивает сборку, передавая параметры через переменные.
   - **Строка CMake**:
     ```shell
     cmake -S . -B $(BUILD_DIR) -DCMAKE_BUILD_TYPE=$(BUILD_TYPE) \
        -DCMAKE_GENERATOR=$(GENERATOR) -DLIB_TYPE=$(LIB_TYPE) -DPOINTTYPE=$(POINT_TYPE)
     ```
   - **Пояснение**: `-S .` указывает текущий каталог как источник проекта. `-B $(BUILD_DIR)` задает директорию для файлов сборки. 

---

```makefile
# Запуск сборки
build:
	cmake --build $(BUILD_DIR)
```

2. **build**:
   - **Описание**: Выполняет команду `cmake --build`, которая запускает сборку из указанной директории `BUILD_DIR`.
   - **Пояснение**: Весь процесс конфигурации и сборки управляется через CMake, который в свою очередь вызывает компилятор.

---

## CMakeLists.txt: Конфигурация проекта

Файл `CMakeLists.txt` определяет конфигурацию сборки и правила для компиляции библиотек и исполняемых файлов.

```cmake
cmake_minimum_required(VERSION 3.10)
project(QuadraticSolver)
```

1. **cmake_minimum_required(VERSION 3.10)**:
   - **Описание**: Указывает минимально поддерживаемую версию CMake.
   - **Почему это важно**: Гарантирует, что все команды, использованные в CMakeLists.txt, будут поддерживаться версией CMake на компьютере пользователя.

2. **project(QuadraticSolver)**:
   - **Описание**: Определяет имя проекта.
   - **Почему это важно**: Имя проекта используется CMake для организации конфигурации, настройки библиотек и исполняемых файлов.

---

### Настройка пользовательских переменных

```cmake
# Определение типа точности (POINTTYPE)
set(POINTTYPE "short" CACHE STRING "Тип точности: short (float) или long (double)")
if(NOT POINTTYPE STREQUAL "short" AND NOT POINTTYPE STREQUAL "long")
    message(FATAL_ERROR "Неверный тип POINTTYPE. Используйте 'short' или 'long'.")
endif()
```

1. **set(POINTTYPE "short" CACHE STRING "...")**:
   - **Описание**: Создает переменную `POINTTYPE`, которая будет использована для определения точности вычислений.
   - **Почему это важно**: Возможность конфигурировать код через переменные CMake позволяет адаптировать программу без модификации исходного кода.

2. **if(NOT POINTTYPE STREQUAL "short" AND NOT POINTTYPE STREQUAL "long")**:
   - **Описание**: Проверка значения переменной. Если `POINTTYPE` не является ни "short", ни "long", то выводится ошибка.
   - **Почему это важно**: Помогает избежать ошибок в случае неправильного ввода параметра. 

---

### Переключение точности с помощью флагов компиляции

```cmake
# Настройка опции точности для библиотеки solver
if(POINTTYPE STREQUAL "long")
    target_compile_definitions(solver PRIVATE USE_DOUBLE_PRECISION)
endif()
```

1. **if(POINTTYPE STREQUAL "long")**:
   - **Описание**: Проверяет значение переменной `POINTTYPE`. Если оно равно "long", то используется тип double.
   - **Почему это важно**: Позволяет условно менять точность вычислений для решения уравнения.

2. **target_compile_definitions(solver PRIVATE USE_DOUBLE_PRECISION)**:
   - **Описание**: Устанавливает флаг `USE_DOUBLE_PRECISION` для компилятора, который будет использован в библиотеке `solver`.
   - **Почему это важно**: С флагом `USE_DOUBLE_PRECISION` можно управлять типом переменных на уровне кода, переключаясь между `float` и `double`.

---

### Добавление и настройка библиотек

```cmake
# Добавление библиотеки парсинга аргументов
add_library(parser ${LIB_TYPE} src/parser.cpp)
target_include_directories(parser PUBLIC ${CMAKE_CURRENT_SOURCE_DIR})
```

1. **add_library(parser ${LIB_TYPE} src/parser.cpp)**:
   - **Описание**: Создает библиотеку `parser` с типом, указанным в переменной `LIB_TYPE`.
   - **Почему это важно**: Позволяет менять тип библиотеки в зависимости от конфигурации проекта.

2. **target_include_directories(parser PUBLIC ${CMAKE_CURRENT_SOURCE_DIR}/src)**:
   - **Описание**: Указывает, что каталог проекта доступен для `parser`.
   - **Почему это важно**: Добавляет пути, по которым `parser` может находить заголовочные файлы, если они в корне проекта.

---

### Подключение библиотек к исполняемому файлу

```cmake
# Связь библиотек с основным исполняемым файлом
target_link_libraries(solution PRIVATE parser solver)
```

1. **target_link_libraries(solution PRIVATE parser solver)**:
   - **Описание**: Подключает библиотеки `parser` и `solver` к исполняемому файлу `solution`.
   - **Почему это важно**: Подключение библиотек позволяет использовать функции, реализованные в `parser` и `solver`, в основном

 файле программы `solution.cpp`.

---

## Заключение

Эта лекция покрывает основные моменты работы с Makefile и CMake для C++ проекта. Мы настроили параметры сборки (тип сборки, генератор, каталог), создали пользовательские переменные и флаги, добавили зависимости и конфигурировали библиотеки.

**Задачи для самостоятельной практики**:
1. Попробуйте изменить тип библиотеки `LIB_TYPE` в Makefile и пересобрать проект.
2. Измените переменную `POINTTYPE` и понаблюдайте, как это меняет точность вычислений.
3. Добавьте в CMakeLists.txt поддержку еще одного флага (например, опцию для логирования) и настройте его использование в коде.

Теперь вы знаете, как настраивать проект, управлять компиляцией через Makefile и CMake и настраивать зависимости между компонентами.
```